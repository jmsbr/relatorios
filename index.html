<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Relatórios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas de Exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #initial-loading {
            position: fixed; inset: 0; background-color: rgba(248, 250, 252, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        .edit-input { display: none; }
        .saving-row { position: relative; opacity: 0.6; pointer-events: none; }
        .row-update { animation: highlight 1.5s ease-out; }
        @keyframes highlight {
            0% { background-color: #fef9c3; }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Loading Inicial -->
    <div id="initial-loading">
        <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-slate-600 font-medium">Sincronizando portal...</p>
    </div>

    <!-- Notificação -->
    <div id="notification" class="hidden fixed top-5 right-5 z-50 p-4 rounded-xl shadow-2xl text-white transition-all duration-300 max-w-sm">
        <p id="notification-message"></p>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Portal de Relatórios</h1>
                <p class="text-slate-600 mt-1">Gestão de Acareações e Financeiro J&T</p>
            </div>
            <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                <button id="refresh-btn" class="p-2.5 bg-white rounded-lg shadow-sm border border-slate-200 text-slate-600 hover:text-indigo-600 transition-all" title="Forçar Atualização">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>
                <img src="https://www.jtexpress.com.br/mobile/static/png/leader_1-c3f7a853.png" alt="Logo" class="h-14 w-auto">
            </div>
        </header>

        <!-- Filtros -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
            <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center uppercase tracking-wider text-xs text-slate-400">Filtros Avançados</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Data Inicial</label>
                    <input type="date" id="filter-date-start" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Data Final</label>
                    <input type="date" id="filter-date-end" class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Nº Pedido</label>
                    <input type="text" id="filter-pedido" placeholder="Procurar..." class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1">Motorista</label>
                    <input type="text" id="filter-motorista" placeholder="Nome..." class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                </div>
            </div>
            
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 pt-4 border-t border-slate-100">
                <div class="flex flex-wrap gap-3">
                    <label class="inline-flex items-center px-3 py-1 bg-slate-50 rounded-full border border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" id="filter-status-all" class="h-3.5 w-3.5 rounded text-indigo-600 focus:ring-0" checked> 
                        <span class="ml-2 text-xs font-semibold text-slate-600 uppercase">Todos</span>
                    </label>
                    <label class="inline-flex items-center px-3 py-1 bg-slate-50 rounded-full border border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" id="filter-status-pending" class="status-filter h-3.5 w-3.5 rounded text-indigo-600 focus:ring-0" checked> 
                        <span class="ml-2 text-xs font-semibold text-slate-600 uppercase">Pendentes</span>
                    </label>
                    <label class="inline-flex items-center px-3 py-1 bg-slate-50 rounded-full border border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" id="filter-status-impresso" class="status-filter h-3.5 w-3.5 rounded text-sky-600 focus:ring-0" checked> 
                        <span class="ml-2 text-xs font-semibold text-slate-600 uppercase">Impressos</span>
                    </label>
                    <label class="inline-flex items-center px-3 py-1 bg-slate-50 rounded-full border border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" id="filter-status-extravio_motorista" class="status-filter h-3.5 w-3.5 rounded text-orange-600 focus:ring-0" checked> 
                        <span class="ml-2 text-xs font-semibold text-slate-600 uppercase">Ext. Motorista</span>
                    </label>
                    <label class="inline-flex items-center px-3 py-1 bg-slate-50 rounded-full border border-slate-200 cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" id="filter-status-extravio_base" class="status-filter h-3.5 w-3.5 rounded text-teal-600 focus:ring-0" checked> 
                        <span class="ml-2 text-xs font-semibold text-slate-600 uppercase">Ext. Base</span>
                    </label>
                </div>
                <button id="filter-btn" class="bg-indigo-600 text-white font-bold py-2 px-10 rounded-lg hover:bg-indigo-700 transition-all text-sm uppercase tracking-wider">
                    Filtrar
                </button>
            </div>
        </div>

        <!-- Resumo Financeiro -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-2">Valor Pedidos (S/M)</h3>
                <p id="total-pedidos-valor" class="text-2xl font-bold text-slate-800">R$ 0,00</p>
                <p id="total-pedidos-qty" class="text-[10px] text-slate-400 mt-1 font-medium">0 documentos</p>
            </div>

            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                <h3 class="text-[10px] font-bold text-amber-500 uppercase tracking-widest mb-2">Total de Multas</h3>
                <p id="total-multas-aplicadas-valor" class="text-2xl font-bold text-slate-800">R$ 0,00</p>
                <p id="total-multas-aplicadas-qty" class="text-[10px] text-slate-400 mt-1 font-medium">0 documentos</p>
            </div>

            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-orange-400">
                <h3 class="text-[10px] font-bold text-orange-500 uppercase tracking-widest mb-1">Ext. Motorista</h3>
                <p id="total-multas-motorista-valor" class="text-xl font-bold text-slate-800">R$ 0,00</p>
                <p id="total-multas-motorista-qty" class="text-[10px] text-slate-400 font-medium mt-1">0 docs ativos</p>
            </div>

            <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm border-l-4 border-l-teal-400">
                <h3 class="text-[10px] font-bold text-teal-500 uppercase tracking-widest mb-1">Ext. Base</h3>
                <p id="total-multas-base-valor" class="text-xl font-bold text-slate-800">R$ 0,00</p>
                <p id="total-multas-base-qty" class="text-[10px] text-slate-400 font-medium mt-1">0 docs ativos</p>
            </div>

            <div class="bg-slate-800 p-5 rounded-xl shadow-lg text-white">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 text-center">Valor Total Geral</h3>
                <p id="total-geral-valor" class="text-2xl font-bold text-center">R$ 0,00</p>
                <p class="text-[9px] text-slate-500 text-center uppercase font-bold mt-2">Soma Final c/ Multas</p>
            </div>
        </div>

        <!-- Tabela -->
        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
            <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h2 class="font-bold text-slate-700 text-xs uppercase tracking-wide">Registos Financeiros</h2>
                <div class="flex space-x-2">
                    <button id="export-excel-btn" class="bg-emerald-600 text-white text-[10px] font-bold py-1.5 px-4 rounded-lg hover:bg-emerald-700 uppercase">Excel</button>
                    <button id="export-pdf-btn" class="bg-red-600 text-white text-[10px] font-bold py-1.5 px-4 rounded-lg hover:bg-red-700 uppercase">PDF</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600" id="report-table">
                    <thead class="bg-slate-50 text-[10px] text-slate-400 uppercase font-black border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4">Arquivo</th>
                            <th class="px-6 py-4">Pedido</th>
                            <th class="px-6 py-4">Motorista</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4 text-right">V. Pedido</th>
                            <th class="px-6 py-4 text-right">V. Multa</th>
                            <th class="px-6 py-4 text-right">Total</th>
                            <th class="px-6 py-4 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="divide-y divide-slate-100">
                        <tr id="empty-state-report"><td colspan="8" class="text-center py-20 text-slate-400 animate-pulse font-medium">Aguardando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const DATABASE_URL = "https://api.npoint.io/ef789e8a4e2cd9900cf7";
            
            const UI = {
                tableBody: document.getElementById('report-table-body'),
                loading: document.getElementById('initial-loading'),
                notify: document.getElementById('notification'),
                notifyMsg: document.getElementById('notification-message'),
                totalPedVal: document.getElementById('total-pedidos-valor'),
                totalPedQty: document.getElementById('total-pedidos-qty'),
                totalMultasVal: document.getElementById('total-multas-aplicadas-valor'),
                totalMultasQty: document.getElementById('total-multas-aplicadas-qty'),
                totalMotVal: document.getElementById('total-multas-motorista-valor'),
                totalMotQty: document.getElementById('total-multas-motorista-qty'),
                totalBaseVal: document.getElementById('total-multas-base-valor'),
                totalBaseQty: document.getElementById('total-multas-base-qty'),
                totalGeralVal: document.getElementById('total-geral-valor')
            };

            let fullDataStore = { files: [] };
            let filteredDataStore = [];
            let isSaving = false;

            const formatBRL = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            function extractPedidoNum(fileName) {
                if (!fileName) return 'N/D';
                const match = fileName.match(/(\d{9,})(?=\.pdf$)/i);
                return match ? match[1] : (fileName.replace('.pdf', '').split(' - ').pop() || 'N/D');
            }

            function extractMotorista(fileName) {
                if (!fileName) return 'N/D';
                let match = fileName.match(/Motorista - F GYN 03 - (.*?)(?=\s- \d{9,}\.pdf)/i);
                if (match) return match[1].trim();
                const parts = fileName.replace('.pdf', '').split(' - ');
                return parts.length > 2 ? parts[parts.length - 2].trim() : 'N/D';
            }

            function showNotify(message, isError = false) {
                UI.notifyMsg.textContent = message;
                UI.notify.className = `fixed top-5 right-5 z-50 p-4 rounded-xl shadow-2xl text-white transition-all duration-300 font-bold text-xs uppercase tracking-widest ${isError ? 'bg-red-600' : 'bg-emerald-600'}`;
                UI.notify.classList.remove('hidden');
                setTimeout(() => UI.notify.classList.add('hidden'), 4000);
            }

            // --- Lógica de Sincronização ---
            async function fetchDB() {
                try {
                    const res = await fetch(`${DATABASE_URL}?_=${Date.now()}`);
                    if (!res.ok) throw new Error("Erro ao ler banco de dados");
                    const data = await res.json();
                    return data && data.files ? data : { files: [] };
                } catch (e) {
                    console.error(e);
                    showNotify("Falha na leitura (npoint.io)", true);
                    return null;
                }
            }

            async function syncDB(payload) {
                if (isSaving) return false;
                isSaving = true;
                try {
                    const res = await fetch(DATABASE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!res.ok) throw new Error("Erro ao gravar no npoint");
                    showNotify("Dados salvos com sucesso!");
                    return true;
                } catch (e) {
                    console.error(e);
                    showNotify("Falha na gravação (npoint.io)", true);
                    return false;
                } finally {
                    isSaving = false;
                }
            }

            function processAndRender(fullUpdate = true) {
                const startDate = document.getElementById('filter-date-start').valueAsNumber;
                const endDate = document.getElementById('filter-date-end').valueAsNumber;
                const pedidoF = document.getElementById('filter-pedido').value.trim().toLowerCase();
                const motoristaF = document.getElementById('filter-motorista').value.trim().toLowerCase();
                const filterAll = document.getElementById('filter-status-all').checked;

                const selStatus = Array.from(document.querySelectorAll('.status-filter'))
                    .filter(cb => cb.checked)
                    .map(cb => cb.id.replace('filter-status-', ''));

                filteredDataStore = fullDataStore.files.filter(f => {
                    const date = f.uploadDate || 0;
                    const dateMatch = (!startDate || date >= startDate) && (!endDate || date <= (endDate + 86400000));
                    const statusMatch = filterAll || selStatus.includes(f.status);
                    const pedidoMatch = !pedidoF || extractPedidoNum(f.fileName).toLowerCase().includes(pedidoF);
                    const motoristaMatch = !motoristaF || extractMotorista(f.fileName).toLowerCase().includes(motoristaF);
                    return dateMatch && statusMatch && pedidoMatch && motoristaMatch;
                });

                updateSummary();
                if (fullUpdate) renderTable();
            }

            function updateSummary() {
                let tPed = 0, tMultas = 0, tMot = 0, tBase = 0;
                let qPed = filteredDataStore.length, qMultas = 0, qMot = 0, qBase = 0;

                filteredDataStore.forEach(f => {
                    const vP = f.valorPedido || 0;
                    const vM = f.valorMulta || 0;
                    tPed += vP;
                    if (f.status === 'extravio_motorista') { tMultas += vM; tMot += vM; qMot++; qMultas++; }
                    else if (f.status === 'extravio_base') { tMultas += vM; tBase += vM; qBase++; qMultas++; }
                });

                UI.totalPedVal.textContent = formatBRL(tPed);
                UI.totalPedQty.textContent = `${qPed} documentos`;
                UI.totalMultasVal.textContent = formatBRL(tMultas);
                UI.totalMultasQty.textContent = `${qMultas} documentos`;
                UI.totalMotVal.textContent = formatBRL(tMot);
                UI.totalMotQty.textContent = `${qMot} docs ativos`;
                UI.totalBaseVal.textContent = formatBRL(tBase);
                UI.totalBaseQty.textContent = `${qBase} docs ativos`;
                UI.totalGeralVal.textContent = formatBRL(tPed + tMultas);
            }

            function renderTable() {
                if (filteredDataStore.length === 0) {
                    UI.tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-20 text-slate-300 font-bold uppercase text-[10px] tracking-widest">Sem Registos</td></tr>';
                    return;
                }

                UI.tableBody.innerHTML = filteredDataStore
                    .sort((a, b) => (b.uploadDate || 0) - (a.uploadDate || 0))
                    .map(f => createRowHTML(f)).join('');
            }

            function createRowHTML(f) {
                const statusMap = {
                    'pending': 'bg-indigo-50 text-indigo-600',
                    'impresso': 'bg-sky-50 text-sky-600',
                    'extravio_motorista': 'bg-orange-50 text-orange-600',
                    'extravio_base': 'bg-teal-50 text-teal-600',
                    'expired': 'bg-red-50 text-red-600'
                };
                const labelMap = {
                    'pending': 'Pendente', 'impresso': 'Impresso', 
                    'extravio_motorista': 'Ext. Motorista', 'extravio_base': 'Ext. Base', 
                    'expired': 'Vencido'
                };

                const valP = f.valorPedido || 0;
                const valM = f.valorMulta || 0;

                return `
                    <tr class="hover:bg-slate-50 transition-colors" data-id="${f.id}">
                        <td class="px-6 py-4 font-bold text-slate-700 truncate max-w-[180px]" title="${f.fileName}">${f.fileName}</td>
                        <td class="px-6 py-4 text-slate-400 font-medium">${extractPedidoNum(f.fileName)}</td>
                        <td class="px-6 py-4 text-slate-500 font-semibold">${extractMotorista(f.fileName)}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-[9px] font-black uppercase ${statusMap[f.status] || 'bg-slate-100'}">${labelMap[f.status] || 'N/D'}</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <span class="view-mode font-bold">${formatBRL(valP)}</span>
                            <input type="number" step="0.01" class="edit-mode edit-input w-20 text-right border rounded px-1 outline-none ring-indigo-500 focus:ring-1" value="${valP}">
                        </td>
                        <td class="px-6 py-4 text-right">
                            <span class="view-mode font-bold">${formatBRL(valM)}</span>
                            <input type="number" step="0.01" class="edit-mode edit-input w-20 text-right border rounded px-1 outline-none ring-indigo-500 focus:ring-1" value="${valM}">
                        </td>
                        <td class="px-6 py-4 text-right font-black text-slate-900 bg-slate-50/50">
                            ${formatBRL(valP + valM)}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button class="edit-btn text-indigo-400 hover:text-indigo-600 p-1">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </button>
                            <button class="save-btn hidden text-emerald-500 hover:text-emerald-700 p-1">
                                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }

            // --- Event Listeners ---
            UI.tableBody.addEventListener('click', async (e) => {
                const tr = e.target.closest('tr');
                if (!tr) return;
                const id = tr.dataset.id;

                if (e.target.closest('.edit-btn')) {
                    tr.querySelectorAll('.view-mode').forEach(el => el.classList.add('hidden'));
                    tr.querySelectorAll('.edit-input').forEach(el => el.style.display = 'inline-block');
                    tr.querySelector('.edit-btn').classList.add('hidden');
                    tr.querySelector('.save-btn').classList.remove('hidden');
                    return;
                }

                if (e.target.closest('.save-btn')) {
                    const inputs = tr.querySelectorAll('input');
                    const newValP = parseFloat(inputs[0].value) || 0;
                    const newValM = parseFloat(inputs[1].value) || 0;

                    tr.classList.add('saving-row');
                    
                    const storeIdx = fullDataStore.files.findIndex(f => f.id === id);
                    if (storeIdx > -1) {
                        fullDataStore.files[storeIdx].valorPedido = newValP;
                        fullDataStore.files[storeIdx].valorMulta = newValM;
                    }

                    // Sincronizar com o servidor
                    const success = await syncDB(fullDataStore);
                    
                    if (success) {
                        tr.classList.add('row-update');
                        tr.querySelector('td:nth-child(5) .view-mode').textContent = formatBRL(newValP);
                        tr.querySelector('td:nth-child(6) .view-mode').textContent = formatBRL(newValM);
                        tr.querySelector('td:nth-child(7)').textContent = formatBRL(newValP + newValM);
                        updateSummary();
                    }

                    tr.classList.remove('saving-row');
                    tr.querySelectorAll('.view-mode').forEach(el => el.classList.remove('hidden'));
                    tr.querySelectorAll('.edit-input').forEach(el => el.style.display = 'none');
                    tr.querySelector('.edit-btn').classList.remove('hidden');
                    tr.querySelector('.save-btn').classList.add('hidden');
                    
                    setTimeout(() => tr.classList.remove('row-update'), 1500);
                }
            });

            document.getElementById('filter-btn').onclick = () => processAndRender(true);
            document.getElementById('refresh-btn').onclick = async () => {
                UI.loading.style.display = 'flex';
                const data = await fetchDB();
                if (data) { fullDataStore = data; processAndRender(true); }
                UI.loading.style.display = 'none';
            };

            // Export Excel
            document.getElementById('export-excel-btn').onclick = () => {
                if (!filteredDataStore.length) return showNotify("Nada para exportar", true);
                const sheet = XLSX.utils.json_to_sheet(filteredDataStore.map(f => ({
                    Arquivo: f.fileName, Pedido: extractPedidoNum(f.fileName), Motorista: extractMotorista(f.fileName),
                    Status: f.status, Valor: f.valorPedido || 0, Multa: f.valorMulta || 0, Total: (f.valorPedido||0)+(f.valorMulta||0)
                })));
                const book = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(book, sheet, "Relatorio");
                XLSX.writeFile(book, "Relatorio.xlsx");
            };

            // Export PDF
            document.getElementById('export-pdf-btn').onclick = () => {
                if (!filteredDataStore.length) return showNotify("Nada para exportar", true);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'pt');
                doc.autoTable({
                    head: [['Arquivo', 'Pedido', 'Motorista', 'Status', 'Valor', 'Multa', 'Total']],
                    body: filteredDataStore.map(f => [
                        f.fileName, extractPedidoNum(f.fileName), extractMotorista(f.fileName),
                        f.status, formatBRL(f.valorPedido||0), formatBRL(f.valorMulta||0), 
                        formatBRL((f.valorPedido||0)+(f.valorMulta||0))
                    ]),
                    styles: { fontSize: 8 }
                });
                doc.save("Relatorio.pdf");
            };

            // Inicialização
            (async () => {
                const data = await fetchDB();
                if (data) { fullDataStore = data; processAndRender(true); }
                UI.loading.style.display = 'none';
            })();
        });
    </script>
</body>
</html>
