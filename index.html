<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Relatórios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas de Exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #initial-loading {
            position: fixed; inset: 0; background-color: rgba(248, 250, 252, 1);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        .edit-input { display: none; }
        .row-saving { background-color: #f1f5f9; opacity: 0.7; }
        
        /* Indicador de Sincronização */
        .sync-status { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 800; text-transform: uppercase; }
        .status-synced { background-color: #dcfce7; color: #166534; }
        .status-pending { background-color: #fef9c3; color: #854d0e; animation: pulse 2s infinite; }
        .status-error { background-color: #fee2e2; color: #991b1b; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Carregamento Inicial -->
    <div id="initial-loading">
        <div class="relative flex items-center justify-center">
            <div class="absolute w-16 h-16 border-4 border-indigo-100 rounded-full"></div>
            <div class="absolute w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <p class="mt-8 text-slate-600 font-bold uppercase tracking-widest text-xs">A Sincronizar Ficheiros...</p>
    </div>

    <!-- Notificações -->
    <div id="notification" class="hidden fixed top-5 right-5 z-50 p-4 rounded-xl shadow-2xl text-white transition-all duration-300 max-w-sm">
        <p id="notification-message" class="text-sm font-bold"></p>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <div class="flex items-center space-x-3">
                    <h1 class="text-3xl font-black text-slate-800 tracking-tighter">Portal de Relatórios</h1>
                    <div id="sync-indicator" class="sync-status status-synced">
                        <span id="sync-text">Sincronizado</span>
                    </div>
                </div>
                <p class="text-slate-500 mt-1 font-medium">Gestão Financeira e Operacional J&T Express</p>
            </div>
            <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                <button id="refresh-btn" class="p-2.5 bg-white rounded-xl shadow-sm border border-slate-200 text-slate-400 hover:text-indigo-600 hover:border-indigo-200 transition-all active:scale-95" title="Atualizar Dados">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>
                <img src="https://www.jtexpress.com.br/mobile/static/png/leader_1-c3f7a853.png" alt="Logótipo J&T" class="h-12 w-auto opacity-90">
            </div>
        </header>

        <!-- Filtros -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">Início do Período</label>
                    <input type="date" id="filter-date-start" class="w-full px-3 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-medium">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">Fim do Período</label>
                    <input type="date" id="filter-date-end" class="w-full px-3 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-medium">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">Número do Pedido</label>
                    <input type="text" id="filter-pedido" placeholder="Ex: 123..." class="w-full px-3 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-medium">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">Nome do Condutor</label>
                    <input type="text" id="filter-motorista" placeholder="Procurar condutor..." class="w-full px-3 py-2.5 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm font-medium">
                </div>
            </div>
            
            <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 pt-6 border-t border-slate-50">
                <div class="flex flex-wrap gap-2">
                    <label class="inline-flex items-center px-4 py-1.5 bg-slate-50 rounded-lg border border-slate-100 cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" id="filter-status-all" class="w-4 h-4 rounded text-indigo-600 focus:ring-0" checked> 
                        <span class="ml-2 text-xs font-bold text-slate-500 uppercase">Todos</span>
                    </label>
                    <label class="inline-flex items-center px-4 py-1.5 bg-slate-50 rounded-lg border border-slate-100 cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" id="filter-status-pending" class="status-filter w-4 h-4 rounded text-indigo-600 focus:ring-0" checked> 
                        <span class="ml-2 text-xs font-bold text-slate-500 uppercase">Pendentes</span>
                    </label>
                    <label class="inline-flex items-center px-4 py-1.5 bg-slate-50 rounded-lg border border-slate-100 cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" id="filter-status-impresso" class="status-filter w-4 h-4 rounded text-sky-600 focus:ring-0" checked> 
                        <span class="ml-2 text-xs font-bold text-slate-500 uppercase text-sky-600">Impressos</span>
                    </label>
                    <label class="inline-flex items-center px-4 py-1.5 bg-slate-50 rounded-lg border border-slate-100 cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" id="filter-status-extravio_motorista" class="status-filter w-4 h-4 rounded text-orange-600 focus:ring-0" checked> 
                        <span class="ml-2 text-xs font-bold text-slate-500 uppercase text-orange-600">Ext. Condutor</span>
                    </label>
                    <label class="inline-flex items-center px-4 py-1.5 bg-slate-50 rounded-lg border border-slate-100 cursor-pointer hover:bg-slate-100 transition-colors">
                        <input type="checkbox" id="filter-status-extravio_base" class="status-filter w-4 h-4 rounded text-teal-600 focus:ring-0" checked> 
                        <span class="ml-2 text-xs font-bold text-slate-500 uppercase text-teal-600">Ext. Base</span>
                    </label>
                </div>
                <button id="filter-btn" class="bg-slate-800 text-white font-black py-3 px-12 rounded-xl hover:bg-slate-900 transition-all text-xs uppercase tracking-widest shadow-lg shadow-slate-200">
                    Filtrar Dados
                </button>
            </div>
        </div>

        <!-- Resumo Financeiro -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                <h3 class="text-[10px] font-black text-blue-500 uppercase tracking-widest mb-2">Valor Pedidos (S/M)</h3>
                <p id="total-pedidos-valor" class="text-2xl font-black text-slate-800 tracking-tighter">€ 0,00</p>
                <p id="total-pedidos-qty" class="text-[10px] text-slate-400 mt-1 font-bold italic">0 documentos</p>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                <h3 class="text-[10px] font-black text-amber-500 uppercase tracking-widest mb-2">Total de Multas</h3>
                <p id="total-multas-aplicadas-valor" class="text-2xl font-black text-slate-800 tracking-tighter">€ 0,00</p>
                <p id="total-multas-aplicadas-qty" class="text-[10px] text-slate-400 mt-1 font-bold italic">0 documentos</p>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-orange-400">
                <h3 class="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-1">Ext. Condutor</h3>
                <p id="total-multas-motorista-valor" class="text-xl font-black text-slate-800">€ 0,00</p>
                <p id="total-multas-motorista-qty" class="text-[10px] text-slate-400 font-bold mt-1 uppercase">0 documentos</p>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-teal-400">
                <h3 class="text-[10px] font-black text-teal-500 uppercase tracking-widest mb-1">Ext. Base</h3>
                <p id="total-multas-base-valor" class="text-xl font-black text-slate-800">€ 0,00</p>
                <p id="total-multas-base-qty" class="text-[10px] text-slate-400 font-bold mt-1 uppercase">0 documentos</p>
            </div>

            <div class="bg-indigo-600 p-5 rounded-2xl shadow-xl shadow-indigo-100 text-white">
                <h3 class="text-[10px] font-bold text-indigo-200 uppercase tracking-widest mb-2 text-center">Valor Total Geral</h3>
                <p id="total-geral-valor" class="text-2xl font-black text-center tracking-tighter">€ 0,00</p>
                <p class="text-[8px] text-indigo-300 text-center uppercase font-black mt-2 tracking-tighter">Faturamento + Multas</p>
            </div>
        </div>

        <!-- Tabela -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-8">
            <div class="p-5 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
                <h2 class="font-black text-slate-400 text-[10px] uppercase tracking-widest">Base de Dados de Ficheiros</h2>
                <div class="flex space-x-2">
                    <button id="manual-save-btn" class="bg-indigo-50 text-indigo-700 text-[10px] font-black py-2 px-5 rounded-lg border border-indigo-100 hover:bg-indigo-100 transition-all uppercase tracking-widest">Guardar Agora</button>
                    <button id="export-excel-btn" class="bg-emerald-50 text-emerald-700 text-[10px] font-black py-2 px-5 rounded-lg border border-emerald-100 hover:bg-emerald-100 transition-all uppercase tracking-widest">Excel</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600" id="report-table">
                    <thead class="bg-slate-50/80 text-[10px] text-slate-400 uppercase font-black border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4">Ficheiro</th>
                            <th class="px-6 py-4">Pedido</th>
                            <th class="px-6 py-4">Condutor</th>
                            <th class="px-6 py-4">Estado</th>
                            <th class="px-6 py-4 text-right">V. Pedido</th>
                            <th class="px-6 py-4 text-right">V. Multa</th>
                            <th class="px-6 py-4 text-right">Total</th>
                            <th class="px-6 py-4 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body" class="divide-y divide-slate-50">
                        <tr id="empty-state-report"><td colspan="8" class="text-center py-24 text-slate-300 font-bold uppercase text-[10px] tracking-widest animate-pulse">A procurar dados no npoint...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const DATABASE_URL = "https://api.npoint.io/ef789e8a4e2cd9900cf7";
            const CACHE_KEY = "portal_relatorios_data";
            
            const UI = {
                tableBody: document.getElementById('report-table-body'),
                loading: document.getElementById('initial-loading'),
                notify: document.getElementById('notification'),
                notifyMsg: document.getElementById('notification-message'),
                totalPedVal: document.getElementById('total-pedidos-valor'),
                totalPedQty: document.getElementById('total-pedidos-qty'),
                totalMultasVal: document.getElementById('total-multas-aplicadas-valor'),
                totalMultasQty: document.getElementById('total-multas-aplicadas-qty'),
                totalMotVal: document.getElementById('total-multas-motorista-valor'),
                totalMotQty: document.getElementById('total-multas-motorista-qty'),
                totalBaseVal: document.getElementById('total-multas-base-valor'),
                totalBaseQty: document.getElementById('total-multas-base-qty'),
                totalGeralVal: document.getElementById('total-geral-valor'),
                syncIndicator: document.getElementById('sync-indicator'),
                syncText: document.getElementById('sync-text'),
                manualSave: document.getElementById('manual-save-btn')
            };

            let fullDataStore = { files: [] };
            let filteredDataStore = [];
            let syncTimeout = null;

            const formatCurrency = (v) => v.toLocaleString('pt-PT', { style: 'currency', currency: 'EUR' });

            const extractPedidoNum = (f) => f ? (f.match(/(\d{9,})(?=\.pdf$)/i)?.[1] || f.replace('.pdf', '').split(' - ').pop()) : 'N/D';
            
            const extractCondutor = (f) => {
                if (!f) return 'N/D';
                const match = f.match(/Motorista - F GYN 03 - (.*?)(?=\s- \d{9,}\.pdf)/i);
                if (match) return match[1].trim();
                const parts = f.replace('.pdf', '').split(' - ');
                return parts.length > 2 ? parts[parts.length - 2].trim() : 'N/D';
            };

            function showNotify(msg, isError = false) {
                UI.notifyMsg.textContent = msg;
                UI.notify.className = `fixed top-5 right-5 z-50 p-4 rounded-xl shadow-2xl text-white transition-all duration-300 font-black text-[10px] uppercase tracking-widest ${isError ? 'bg-red-600' : 'bg-indigo-600'}`;
                UI.notify.classList.remove('hidden');
                setTimeout(() => UI.notify.classList.add('hidden'), 5000);
            }

            // --- Lógica de Sincronização e Erro ---

            function updateSyncUI(status) {
                UI.syncIndicator.classList.remove('status-synced', 'status-pending', 'status-error');
                if (status === 'syncing') {
                    UI.syncIndicator.classList.add('status-pending');
                    UI.syncText.textContent = "A Guardar...";
                } else if (status === 'error') {
                    UI.syncIndicator.classList.add('status-error');
                    UI.syncText.textContent = "Erro ao Guardar";
                } else {
                    UI.syncIndicator.classList.add('status-synced');
                    UI.syncText.textContent = "Sincronizado";
                }
            }

            async function performNetworkSync(manual = false) {
                updateSyncUI('syncing');
                if (manual) showNotify("A tentar guardar no servidor...");

                try {
                    // Tentativa 1: PUT (Mais seguro para updates)
                    let response = await fetch(DATABASE_URL, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(fullDataStore)
                    });

                    // Tentativa 2: POST (Caso o npoint esteja configurado para POST apenas)
                    if (!response.ok) {
                        response = await fetch(DATABASE_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(fullDataStore)
                        });
                    }

                    if (!response.ok) {
                        throw new Error(`Servidor respondeu com erro: ${response.status}`);
                    }

                    updateSyncUI('synced');
                    if (manual) showNotify("Dados guardados com sucesso no npoint!");
                    localStorage.setItem(CACHE_KEY, JSON.stringify(fullDataStore));
                } catch (e) {
                    console.error("Erro no Sync:", e);
                    updateSyncUI('error');
                    showNotify(`Erro Crítico: ${e.message}. Tente o botão 'Guardar Agora'.`, true);
                }
            }

            function scheduleSync() {
                if (syncTimeout) clearTimeout(syncTimeout);
                updateSyncUI('syncing');
                syncTimeout = setTimeout(() => performNetworkSync(), 2500);
            }

            async function loadInitialData() {
                // Cache local para rapidez imediata
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    fullDataStore = JSON.parse(cached);
                    processAndRender(true);
                    UI.loading.style.display = 'none';
                }

                try {
                    const res = await fetch(`${DATABASE_URL}?_=${Date.now()}`);
                    if (!res.ok) throw new Error(`Falha ao ler servidor (${res.status})`);
                    
                    const data = await res.json();
                    if (data && Array.isArray(data.files)) {
                        fullDataStore = data;
                        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                        processAndRender(true);
                    }
                } catch (e) {
                    showNotify(`Erro de Leitura: ${e.message}`, true);
                } finally {
                    UI.loading.style.display = 'none';
                }
            }

            // --- Renderização ---

            function processAndRender(fullUpdate = true) {
                const startDate = document.getElementById('filter-date-start').valueAsNumber;
                const endDate = document.getElementById('filter-date-end').valueAsNumber;
                const pedidoF = document.getElementById('filter-pedido').value.trim().toLowerCase();
                const motoristaF = document.getElementById('filter-motorista').value.trim().toLowerCase();
                const filterAll = document.getElementById('filter-status-all').checked;

                const selStatus = Array.from(document.querySelectorAll('.status-filter'))
                    .filter(cb => cb.checked)
                    .map(cb => cb.id.replace('filter-status-', ''));

                filteredDataStore = fullDataStore.files.filter(f => {
                    const date = f.uploadDate || 0;
                    const dateMatch = (!startDate || date >= startDate) && (!endDate || date <= (endDate + 86400000));
                    const statusMatch = filterAll || selStatus.includes(f.status);
                    const pedidoMatch = !pedidoF || extractPedidoNum(f.fileName).toLowerCase().includes(pedidoF);
                    const condutorMatch = !motoristaF || extractCondutor(f.fileName).toLowerCase().includes(motoristaF);
                    return dateMatch && statusMatch && pedidoMatch && condutorMatch;
                });

                updateSummary();
                if (fullUpdate) renderTable();
            }

            function updateSummary() {
                let tPed = 0, tMultas = 0, tMot = 0, tBase = 0;
                let qPed = filteredDataStore.length, qMultas = 0, qMot = 0, qBase = 0;

                filteredDataStore.forEach(f => {
                    const vP = f.valorPedido || 0;
                    const vM = f.valorMulta || 0;
                    tPed += vP;
                    if (f.status === 'extravio_motorista') { tMultas += vM; tMot += vM; qMot++; qMultas++; }
                    else if (f.status === 'extravio_base') { tMultas += vM; tBase += vM; qBase++; qMultas++; }
                });

                UI.totalPedVal.textContent = formatCurrency(tPed);
                UI.totalPedQty.textContent = `${qPed} documentos`;
                UI.totalMultasVal.textContent = formatCurrency(tMultas);
                UI.totalMultasQty.textContent = `${qMultas} documentos`;
                UI.totalMotVal.textContent = formatCurrency(tMot);
                UI.totalMotQty.textContent = `${qMot} documentos`;
                UI.totalBaseVal.textContent = formatCurrency(tBase);
                UI.totalBaseQty.textContent = `${qBase} documentos`;
                UI.totalGeralVal.textContent = formatCurrency(tPed + tMultas);
            }

            function renderTable() {
                if (filteredDataStore.length === 0) {
                    UI.tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-20 text-slate-300 font-black uppercase text-[10px] tracking-widest">Nenhum registo encontrado</td></tr>';
                    return;
                }

                UI.tableBody.innerHTML = filteredDataStore
                    .sort((a, b) => (b.uploadDate || 0) - (a.uploadDate || 0))
                    .map(f => createRowHTML(f)).join('');
            }

            function createRowHTML(f) {
                const statusMap = {
                    'pending': 'bg-indigo-50 text-indigo-600',
                    'impresso': 'bg-sky-50 text-sky-600',
                    'extravio_motorista': 'bg-orange-50 text-orange-600',
                    'extravio_base': 'bg-teal-50 text-teal-600',
                    'expired': 'bg-red-50 text-red-600'
                };
                const labelMap = {
                    'pending': 'Pendente', 'impresso': 'Impresso', 
                    'extravio_motorista': 'Ext. Condutor', 'extravio_base': 'Ext. Base', 
                    'expired': 'Vencido'
                };

                const valP = f.valorPedido || 0;
                const valM = f.valorMulta || 0;

                return `
                    <tr class="hover:bg-slate-50 transition-colors" data-id="${f.id}">
                        <td class="px-6 py-4 font-black text-slate-700 truncate max-w-[180px]" title="${f.fileName}">${f.fileName}</td>
                        <td class="px-6 py-4 text-slate-400 font-bold">${extractPedidoNum(f.fileName)}</td>
                        <td class="px-6 py-4 text-slate-500 font-bold">${extractCondutor(f.fileName)}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded text-[9px] font-black uppercase ${statusMap[f.status] || 'bg-slate-100'}">${labelMap[f.status] || 'N/D'}</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <span class="view-mode font-black text-slate-800">${formatCurrency(valP)}</span>
                            <input type="number" step="0.01" class="edit-mode edit-input w-24 text-right border border-indigo-200 rounded-lg px-2 py-1 outline-none focus:ring-2 ring-indigo-500" value="${valP}">
                        </td>
                        <td class="px-6 py-4 text-right">
                            <span class="view-mode font-black text-slate-800">${formatCurrency(valM)}</span>
                            <input type="number" step="0.01" class="edit-mode edit-input w-24 text-right border border-indigo-200 rounded-lg px-2 py-1 outline-none focus:ring-2 ring-indigo-500" value="${valM}">
                        </td>
                        <td class="px-6 py-4 text-right font-black text-slate-900 bg-slate-50/50">
                            ${formatCurrency(valP + valM)}
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button class="edit-btn text-slate-300 hover:text-indigo-600 p-2 transition-colors">
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                            </button>
                            <button class="save-btn hidden text-emerald-500 hover:text-emerald-700 p-2 transition-colors">
                                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
                            </button>
                        </td>
                    </tr>
                `;
            }

            // --- Event Listeners ---

            UI.tableBody.addEventListener('click', (e) => {
                const tr = e.target.closest('tr');
                if (!tr) return;
                const id = tr.dataset.id;

                if (e.target.closest('.edit-btn')) {
                    tr.querySelectorAll('.view-mode').forEach(el => el.classList.add('hidden'));
                    tr.querySelectorAll('.edit-input').forEach(el => el.style.display = 'inline-block');
                    tr.querySelector('.edit-btn').classList.add('hidden');
                    tr.querySelector('.save-btn').classList.remove('hidden');
                    return;
                }

                if (e.target.closest('.save-btn')) {
                    const inputs = tr.querySelectorAll('input');
                    const newValP = parseFloat(inputs[0].value) || 0;
                    const newValM = parseFloat(inputs[1].value) || 0;

                    const storeIdx = fullDataStore.files.findIndex(f => f.id === id);
                    if (storeIdx > -1) {
                        fullDataStore.files[storeIdx].valorPedido = newValP;
                        fullDataStore.files[storeIdx].valorMulta = newValM;
                        
                        tr.querySelector('td:nth-child(5) .view-mode').textContent = formatCurrency(newValP);
                        tr.querySelector('td:nth-child(6) .view-mode').textContent = formatCurrency(newValM);
                        tr.querySelector('td:nth-child(7)').textContent = formatCurrency(newValP + newValM);
                        
                        updateSummary();
                        tr.querySelectorAll('.view-mode').forEach(el => el.classList.remove('hidden'));
                        tr.querySelectorAll('.edit-input').forEach(el => el.style.display = 'none');
                        tr.querySelector('.edit-btn').classList.remove('hidden');
                        tr.querySelector('.save-btn').classList.add('hidden');
                        
                        scheduleSync();
                    }
                }
            });

            document.getElementById('filter-btn').onclick = () => processAndRender(true);
            document.getElementById('refresh-btn').onclick = () => loadInitialData();
            UI.manualSave.onclick = () => performNetworkSync(true);

            loadInitialData();
        });
    </script>
</body>
</html>
