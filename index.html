<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Relatórios - JMSBR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bibliotecas de Exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        #initial-loading {
            position: fixed;
            inset: 0;
            background-color: rgba(248, 250, 252, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .edit-input { display: none; }
        .row-editing .edit-span { display: none; }
        .row-editing .edit-input { display: block; }
        
        /* Consola de Migração */
        #migration-console {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 500px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 60;
            padding: 20px;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-50">

    <!-- Loading Inicial -->
    <div id="initial-loading">
        <svg class="animate-spin h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p id="loading-text" class="mt-4 text-slate-700 font-medium tracking-tight">A sincronizar com Firebase...</p>
    </div>

    <!-- Notificação -->
    <div id="notification" class="hidden fixed top-5 right-5 z-50 p-4 rounded-xl shadow-2xl text-white transition-all duration-300 max-w-sm">
        <p id="notification-message" class="text-sm font-semibold"></p>
    </div>

    <!-- Consola de Migração de Dados -->
    <div id="migration-console">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></div>
                <h3 class="font-bold text-slate-800">Migração de Dados (251 itens)</h3>
            </div>
            <button onclick="document.getElementById('migration-console').style.display='none'" class="text-slate-400 hover:text-slate-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        
        <div class="mb-4">
            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">1. Selecionar Ficheiro JSON</label>
            <input type="file" id="migration-file-input" accept=".txt,.json" class="w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
        </div>

        <div id="migration-progress-container" class="hidden mb-4">
            <div class="flex justify-between text-[10px] font-bold text-slate-500 mb-1">
                <span>PROGRESSO</span>
                <span id="migration-perc">0%</span>
            </div>
            <div class="w-full bg-slate-100 rounded-full h-1.5">
                <div id="migration-bar" class="bg-indigo-600 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
        </div>

        <div id="migration-log" class="bg-slate-900 p-3 rounded-lg text-[10px] font-mono mb-4 h-40 overflow-y-auto text-indigo-300 border border-slate-800">
            Aguardando ficheiro...
        </div>

        <button id="start-migration-btn" disabled class="w-full bg-slate-200 text-slate-400 cursor-not-allowed font-bold py-3 rounded-xl text-sm transition-all shadow-lg shadow-indigo-100">
            Iniciar Migração
        </button>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Portal de Relatórios</h1>
                <p class="text-slate-500 mt-1 flex items-center">
                    <span class="w-2 h-2 bg-emerald-500 rounded-full mr-2"></span>
                    Base de dados Firebase Ativa
                </p>
            </div>
            <div class="flex items-center space-x-3 mt-4 sm:mt-0">
                <button id="show-migration-btn" class="bg-amber-50 text-amber-600 hover:bg-amber-100 px-4 py-2 rounded-xl font-bold text-xs uppercase transition-all flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                    Migrar 251 Itens
                </button>
                <img src="https://www.jtexpress.com.br/mobile/static/png/leader_1-c3f7a853.png" alt="Logótipo J&T Express" class="h-10 w-auto">
            </div>
        </header>

        <!-- Filtros -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Início</label>
                    <input type="date" id="filter-date-start" class="w-full px-4 py-2 bg-slate-50 border-0 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Fim</label>
                    <input type="date" id="filter-date-end" class="w-full px-4 py-2 bg-slate-50 border-0 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Nº Encomenda</label>
                    <input type="text" id="filter-pedido" placeholder="888..." class="w-full px-4 py-2 bg-slate-50 border-0 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Motorista</label>
                    <input type="text" id="filter-motorista" placeholder="Nome..." class="w-full px-4 py-2 bg-slate-50 border-0 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none">
                </div>
            </div>
            
            <div class="mt-6 flex flex-wrap items-center gap-4 border-t border-slate-100 pt-6">
                <span class="text-xs font-bold text-slate-400 uppercase">Status:</span>
                <label class="flex items-center text-sm text-slate-600 font-medium cursor-pointer"><input type="checkbox" id="filter-status-all" class="rounded-md text-indigo-600 mr-2 border-slate-300" checked> Todos</label>
                <label class="flex items-center text-sm text-slate-600 font-medium cursor-pointer"><input type="checkbox" id="filter-status-pending" class="status-filter rounded-md text-indigo-600 mr-2 border-slate-300" checked> Pendentes</label>
                <label class="flex items-center text-sm text-slate-600 font-medium cursor-pointer"><input type="checkbox" id="filter-status-impresso" class="status-filter rounded-md text-sky-600 mr-2 border-slate-300" checked> Impressos</label>
                <label class="flex items-center text-sm text-slate-600 font-medium cursor-pointer"><input type="checkbox" id="filter-status-extravio_motorista" class="status-filter rounded-md text-orange-600 mr-2 border-slate-300" checked> Extr. Motorista</label>
                <label class="flex items-center text-sm text-slate-600 font-medium cursor-pointer"><input type="checkbox" id="filter-status-extravio_base" class="status-filter rounded-md text-teal-600 mr-2 border-slate-300" checked> Extr. Base</label>
                <div class="ml-auto">
                    <button id="apply-filters-btn" class="bg-slate-900 hover:bg-black text-white px-8 py-2.5 rounded-xl font-bold transition-all shadow-lg shadow-slate-200">Filtrar Resultados</button>
                </div>
            </div>
        </div>

        <!-- Cards de Resumo -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm transition-transform hover:scale-[1.02]">
                <div class="flex items-center justify-between mb-4">
                    <span class="p-3 bg-blue-50 text-blue-600 rounded-2xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></span>
                    <span id="qty-total-pedidos" class="text-xs font-bold text-slate-400">0 docs</span>
                </div>
                <h3 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Total Encomendas</h3>
                <p id="total-pedidos-valor" class="text-2xl font-bold text-slate-800 mt-1">R$ 0,00</p>
            </div>

            <div class="bg-white p-6 rounded-2xl border border-orange-200 shadow-sm transition-transform hover:scale-[1.02]">
                <div class="flex items-center justify-between mb-4">
                    <span class="p-3 bg-orange-50 text-orange-600 rounded-2xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></span>
                    <span id="qty-extravio-motorista" class="text-xs font-bold text-orange-400">0 docs</span>
                </div>
                <h3 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Multa Motorista</h3>
                <p id="total-multas-motorista" class="text-2xl font-bold text-orange-600 mt-1">R$ 0,00</p>
            </div>

            <div class="bg-white p-6 rounded-2xl border border-teal-200 shadow-sm transition-transform hover:scale-[1.02]">
                <div class="flex items-center justify-between mb-4">
                    <span class="p-3 bg-teal-50 text-teal-600 rounded-2xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg></span>
                    <span id="qty-extravio-base" class="text-xs font-bold text-teal-400">0 docs</span>
                </div>
                <h3 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Multa Base</h3>
                <p id="total-multas-base" class="text-2xl font-bold text-teal-600 mt-1">R$ 0,00</p>
            </div>

            <div class="bg-indigo-600 p-6 rounded-2xl shadow-xl shadow-indigo-200 transition-transform hover:scale-[1.02]">
                <div class="flex items-center justify-between mb-4">
                    <span class="p-3 bg-indigo-500/50 text-white rounded-2xl"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg></span>
                    <span id="qty-total-geral" class="text-xs font-bold text-indigo-200">0 docs</span>
                </div>
                <h3 class="text-indigo-100 text-[10px] font-bold uppercase tracking-widest">Valor Total Geral</h3>
                <p id="total-geral-valor" class="text-2xl font-bold text-white mt-1">R$ 0,00</p>
            </div>
        </div>

        <!-- Tabela -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-slate-100">
                <h2 class="text-xl font-bold text-slate-800">Listagem Consolidada</h2>
                <div class="flex space-x-3 mt-4 sm:mt-0">
                    <button id="export-excel-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-5 rounded-xl flex items-center transition-all text-xs">Exportar Excel</button>
                    <button id="export-pdf-btn" class="bg-rose-500 hover:bg-rose-600 text-white font-bold py-2 px-5 rounded-xl flex items-center transition-all text-xs">Gerar PDF</button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600" id="main-table">
                    <thead class="bg-slate-50 text-[10px] text-slate-400 uppercase font-bold border-b border-slate-100">
                        <tr>
                            <th class="px-6 py-4">Ficheiro / Motorista</th>
                            <th class="px-6 py-4">Nº Encomenda</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4 text-right">V. Pedido</th>
                            <th class="px-6 py-4 text-right">V. Multa</th>
                            <th class="px-6 py-4 text-right">Total</th>
                            <th class="px-6 py-4">Data Envio</th>
                            <th class="px-6 py-4 text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-50">
                    </tbody>
                </table>
            </div>
            
            <div id="empty-state" class="p-24 text-center">
                <div class="bg-slate-50 inline-block p-8 rounded-full mb-4">
                    <svg class="w-12 h-12 text-slate-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg>
                </div>
                <p id="empty-state-text" class="text-slate-400 font-medium">A aguardar conexão ao Firebase...</p>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, doc, updateDoc, setDoc, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLtYecb_VeHuqNUiqkDwIoQQP_3HuW2vg",
            authDomain: "jmsbr-81be4.firebaseapp.com",
            projectId: "jmsbr-81be4",
            storageBucket: "jmsbr-81be4.firebasestorage.app",
            messagingSenderId: "461966861390",
            appId: "1:461966861390:web:2e8e1a164f99f7719c4f1f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "jmsbr-81be4";

        let allDocuments = [];
        let filteredDocuments = [];
        let dataToMigrate = [];
        
        const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'acareacoes');

        // Helpers
        const fmtBRL = (v) => (v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const fmtDate = (v) => v ? new Date(v).toLocaleDateString('pt-PT') : '-';

        function extractPedido(fileName) {
            if (!fileName) return '-';
            const match = fileName.match(/(\d{9,})(?=\.pdf$)/i);
            return match ? match[1] : fileName.split(' - ').pop().replace('.pdf', '');
        }

        function extractMotorista(fileName) {
            if (!fileName) return 'N/A';
            const parts = fileName.split(' - ');
            return parts.length >= 3 ? parts[parts.length - 2].trim() : 'Motorista Indefinido';
        }

        function notify(msg, type = 'success') {
            const el = document.getElementById('notification');
            const txt = document.getElementById('notification-message');
            txt.textContent = msg;
            el.className = `fixed top-5 right-5 z-50 p-4 rounded-xl shadow-2xl transition-all duration-300 max-w-sm ${type === 'success' ? 'bg-emerald-500' : 'bg-rose-500'}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 4000);
        }

        function renderTable() {
            const tbody = document.getElementById('table-body');
            const emptyState = document.getElementById('empty-state');
            
            if (filteredDocuments.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                document.getElementById('empty-state-text').textContent = "Nenhum registo encontrado no Firebase.";
                return;
            }

            emptyState.classList.add('hidden');
            tbody.innerHTML = filteredDocuments.map(docData => {
                const statusMap = {
                    'pending': { label: 'Pendente', class: 'bg-indigo-50 text-indigo-600' },
                    'impresso': { label: 'Impresso', class: 'bg-sky-50 text-sky-600' },
                    'extravio_motorista': { label: 'Multa Motorista', class: 'bg-orange-50 text-orange-600 border-orange-100' },
                    'extravio_base': { label: 'Multa Base', class: 'bg-teal-50 text-teal-600 border-teal-100' },
                    'expired': { label: 'Vencido', class: 'bg-rose-50 text-rose-600' }
                };
                const s = statusMap[docData.status] || { label: 'Pendente', class: 'bg-slate-100 text-slate-500' };
                const total = (docData.valorPedido || 0) + (docData.valorMulta || 0);

                return `
                    <tr class="hover:bg-slate-50/50 transition-colors" data-id="${docData.id}">
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-800 text-sm truncate max-w-[220px]">${docData.fileName}</div>
                            <div class="text-[10px] text-slate-400 mt-0.5 font-bold uppercase">${extractMotorista(docData.fileName)}</div>
                        </td>
                        <td class="px-6 py-4 font-mono text-xs text-slate-500">${extractPedido(docData.fileName)}</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-lg text-[9px] font-bold uppercase ${s.class}">${s.label}</span>
                        </td>
                        <td class="px-6 py-4 text-right whitespace-nowrap">
                            <span class="edit-span font-bold text-slate-700">${fmtBRL(docData.valorPedido)}</span>
                            <input type="number" step="0.01" value="${docData.valorPedido || 0}" class="edit-input w-24 text-right px-2 py-1 border border-indigo-200 rounded-lg text-xs outline-none">
                        </td>
                        <td class="px-6 py-4 text-right whitespace-nowrap">
                            <span class="edit-span font-bold text-slate-700">${fmtBRL(docData.valorMulta)}</span>
                            <input type="number" step="0.01" value="${docData.valorMulta || 0}" class="edit-input w-24 text-right px-2 py-1 border border-indigo-200 rounded-lg text-xs outline-none">
                        </td>
                        <td class="px-6 py-4 text-right font-bold text-slate-900 whitespace-nowrap">${fmtBRL(total)}</td>
                        <td class="px-6 py-4 text-[10px] text-slate-400 font-bold">${fmtDate(docData.uploadDate)}</td>
                        <td class="px-6 py-4 text-center">
                            <button class="edit-btn p-2 text-indigo-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-xl transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></button>
                            <button class="save-btn hidden p-2 text-emerald-500 hover:text-emerald-700 hover:bg-emerald-50 rounded-xl transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"/></svg></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateSummary() {
            const totals = filteredDocuments.reduce((acc, curr) => {
                const vp = curr.valorPedido || 0;
                const vm = curr.valorMulta || 0;
                acc.pedidos += vp;
                if (curr.status === 'extravio_motorista') { acc.multasM += vm; acc.qtyM++; }
                if (curr.status === 'extravio_base') { acc.multasB += vm; acc.qtyB++; }
                return acc;
            }, { pedidos: 0, multasM: 0, multasB: 0, qtyM: 0, qtyB: 0 });

            document.getElementById('total-pedidos-valor').textContent = fmtBRL(totals.pedidos);
            document.getElementById('qty-total-pedidos').textContent = `${filteredDocuments.length} docs`;
            document.getElementById('total-multas-motorista').textContent = fmtBRL(totals.multasM);
            document.getElementById('qty-extravio-motorista').textContent = `${totals.qtyM} docs`;
            document.getElementById('total-multas-base').textContent = fmtBRL(totals.multasB);
            document.getElementById('qty-extravio-base').textContent = `${totals.qtyB} docs`;
            document.getElementById('total-geral-valor').textContent = fmtBRL(totals.pedidos + totals.multasM + totals.multasB);
            document.getElementById('qty-total-geral').textContent = `${filteredDocuments.length} docs`;
        }

        function applyFilters() {
            const start = document.getElementById('filter-date-start').valueAsNumber;
            const end = document.getElementById('filter-date-end').valueAsNumber;
            const pedidoTerm = document.getElementById('filter-pedido').value.toLowerCase();
            const motoristaTerm = document.getElementById('filter-motorista').value.toLowerCase();
            const filterAll = document.getElementById('filter-status-all').checked;
            
            const selectedStatuses = [];
            if (!filterAll) {
                document.querySelectorAll('.status-filter').forEach(cb => {
                    if (cb.checked) selectedStatuses.push(cb.id.replace('filter-status-', ''));
                });
            }

            filteredDocuments = allDocuments.filter(docData => {
                const date = docData.uploadDate || 0;
                if (start && date < start) return false;
                if (end && date > (end + 86400000)) return false;
                if (pedidoTerm && !extractPedido(docData.fileName).toLowerCase().includes(pedidoTerm)) return false;
                if (motoristaTerm && !extractMotorista(docData.fileName).toLowerCase().includes(motoristaTerm)) return false;
                if (!filterAll && !selectedStatuses.includes(docData.status)) return false;
                return true;
            });

            renderTable();
            updateSummary();
        }

        // LÓGICA DE MIGRAÇÃO (PARA 251 ITENS)
        document.getElementById('show-migration-btn').onclick = () => {
            document.getElementById('migration-console').style.display = 'block';
        };

        // Ler Ficheiro de Migração
        document.getElementById('migration-file-input').onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const json = JSON.parse(event.target.result);
                    dataToMigrate = json.files || [];
                    document.getElementById('migration-log').innerHTML = `Ficheiro detetado!<br>Registos encontrados: <b>${dataToMigrate.length}</b><br><br>Clique em Iniciar para migrar para o Firebase.`;
                    
                    const btn = document.getElementById('start-migration-btn');
                    btn.disabled = false;
                    btn.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                    btn.classList.add('bg-indigo-600', 'text-white');
                } catch (err) {
                    notify("Erro ao ler JSON. Verifique o formato.", "error");
                }
            };
            reader.readAsText(file);
        };

        document.getElementById('start-migration-btn').onclick = async () => {
            const log = document.getElementById('migration-log');
            const btn = document.getElementById('start-migration-btn');
            const prog = document.getElementById('migration-progress-container');
            const bar = document.getElementById('migration-bar');
            const perc = document.getElementById('migration-perc');

            btn.disabled = true;
            btn.textContent = "Processando Migração...";
            prog.classList.remove('hidden');
            log.innerHTML = "Iniciando migração total...<br>";

            let success = 0;
            let errorCount = 0;

            for (let i = 0; i < dataToMigrate.length; i++) {
                const item = dataToMigrate[i];
                try {
                    // LIMPEZA: Remover fileURL (Base64 pesado) para não quebrar o Firestore
                    const cleanItem = { ...item };
                    delete cleanItem.fileURL; 
                    if (!cleanItem.id) cleanItem.id = Date.now().toString() + i;

                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'acareacoes', cleanItem.id), cleanItem);
                    
                    success++;
                    const progress = Math.round(((i + 1) / dataToMigrate.length) * 100);
                    bar.style.width = progress + '%';
                    perc.textContent = progress + '%';
                    
                    if (i % 5 === 0) { // Log a cada 5 itens para não travar o browser
                        log.innerHTML += `<span class="text-emerald-400">✓ Item ${i+1}/${dataToMigrate.length} migrado</span><br>`;
                        log.scrollTop = log.scrollHeight;
                    }
                } catch (e) {
                    errorCount++;
                    log.innerHTML += `<span class="text-rose-400">✗ Erro no ID ${item.id}</span><br>`;
                }
            }

            log.innerHTML += `<br><b>MIGRAÇÃO CONCLUÍDA!</b><br>Sucesso: ${success}<br>Erros: ${errorCount}`;
            btn.textContent = "Migração Terminada";
            notify(`Migrados ${success} itens com sucesso!`);
        };

        // Eventos de Tabela e App
        document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);
        
        document.getElementById('table-body').addEventListener('click', async (e) => {
            const row = e.target.closest('tr');
            if (!row) return;
            const docId = row.dataset.id;
            
            if (e.target.closest('.edit-btn')) {
                row.classList.add('row-editing');
                row.querySelector('.edit-btn').classList.add('hidden');
                row.querySelector('.save-btn').classList.remove('hidden');
            } else if (e.target.closest('.save-btn')) {
                const inputs = row.querySelectorAll('.edit-input');
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'acareacoes', docId), {
                        valorPedido: parseFloat(inputs[0].value) || 0,
                        valorMulta: parseFloat(inputs[1].value) || 0
                    });
                    notify("Alterações guardadas no Firebase.");
                    row.classList.remove('row-editing');
                    row.querySelector('.edit-btn').classList.remove('hidden');
                    row.querySelector('.save-btn').classList.add('hidden');
                } catch (err) {
                    notify("Erro ao atualizar base de dados.", "error");
                }
            }
        });

        // Inicialização
        async function initApp() {
            try {
                const userCred = await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const q = query(collectionRef, orderBy('uploadDate', 'desc'));
                        onSnapshot(q, (snapshot) => {
                            allDocuments = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                            applyFilters();
                            document.getElementById('initial-loading').style.display = 'none';
                        });
                    }
                });
            } catch (err) {
                notify("Erro fatal de ligação.", "error");
                document.getElementById('loading-text').textContent = "Erro de Ligação ao Firebase";
            }
        }

        initApp();
    </script>
</body>
</html>
